@startuml
' =============================
' DATABASE SCHEMA (Unified & Enhanced)
' =============================

entity "payments" {
  + id : UUID <<PK>>
  --
  amount : DECIMAL(19,4)
  currency : VARCHAR(3)
  status : ENUM('PENDING','COMPLETED','FAILED','REFUNDED')
  processor_reference : VARCHAR(255) <<UNIQUE>>
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "payment_events" {
  + id : UUID <<PK>>
  --
  payment_id : UUID <<FK>> "references payments(id)"
  event_type : VARCHAR(50)
  timestamp : TIMESTAMP
  details : TEXT
  metadata : JSON
}

entity "invoices" {
  + id : UUID <<PK>>
  --
  payment_id : UUID <<FK>> <<UNIQUE>> "references payments(id)"
  invoice_number : VARCHAR(50) <<UNIQUE>>
  issued_at : TIMESTAMP
  due_date : TIMESTAMP
  tax_amount : DECIMAL(19,4)
  total_amount : DECIMAL(19,4)
}

entity "payment_retries" {
  + id : UUID <<PK>>
  --
  payment_id : UUID <<FK>> "references payments(id)"
  retry_count : INTEGER
  next_retry_at : TIMESTAMP
  max_retries : INTEGER
  last_error : TEXT
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

' Relationships
payments ||--o{ payment_events : "generates"
payments ||--o| invoices : "billed to"
payments ||--o{ payment_retries : "has retries"

note right of payments
  Represents a payment transaction.
  Includes processor reference, amount and status.
end note

note right of payment_events
  Domain-level log of payment lifecycle.
  Useful for auditing and debugging.
end note

note right of invoices
  Generated billing documents.
  Snapshot of tax and total at issue time.
end note

note right of payment_retries
  Retry metadata for failed payments.
  Used in PaymentRetryPolicy logic.
end note

@enduml
